# Tabla de calibración estequiométrica de Unidades Hounsfield (HU) a materiales
# Para conversión de imágenes CT a phantoms de simulación en Geant4

# ==================================================
# Información General
# ==================================================
calibration_info:
  scanner_model: "Generic CT Scanner"
  kvp: 120  # kVp del escáner
  calibration_date: "2025-01-31"
  calibration_phantom: "Gammex 467"
  notes: |
    Tabla basada en calibración estequiométrica estándar para tejidos humanos.
    Referencias:
    - Schneider et al. (2000) Phys Med Biol 45:459-478
    - ICRU Report 46: Photon, Electron, Proton and Neutron Interaction Data

# ==================================================
# Rango de Unidades Hounsfield
# ==================================================
hu_range:
  min: -1024  # Aire
  max: 3071   # Hueso cortical denso / Metal
  default: 0  # Agua

# ==================================================
# Tolerancia de Densidad para Optimización
# ==================================================
# Agrupa voxels con densidades similares en un único material de Geant4
# para reducir overhead de inicialización
density_tolerance:
  gcm3: 0.01  # g/cm³
  # Ejemplo: densidades entre 1.00 y 1.01 g/cm³ se tratarán como un mismo material

# ==================================================
# Tabla de Materiales por Rango de HU
# ==================================================
# Formato: [HU_min, HU_max, material_name, density_gcm3, composition]
materials:
  # Aire y gases
  - hu_min: -1024
    hu_max: -950
    material: "G4_AIR"
    density_gcm3: 0.001205
    composition:
      N: 0.755268
      O: 0.231781
      Ar: 0.012827
      C: 0.000124
    description: "Aire ambiente"
  
  # Pulmón (inflado)
  - hu_min: -950
    hu_max: -700
    material: "LungInhale"
    density_gcm3: 0.217
    composition:
      H: 0.103
      C: 0.105
      N: 0.031
      O: 0.749
      Na: 0.002
      P: 0.002
      S: 0.003
      Cl: 0.003
      K: 0.002
    description: "Pulmón inflado (inhalación)"
  
  # Pulmón (deflado)
  - hu_min: -700
    hu_max: -300
    material: "LungExhale"
    density_gcm3: 0.508
    composition:
      H: 0.103
      C: 0.105
      N: 0.031
      O: 0.749
      Na: 0.002
      P: 0.002
      S: 0.003
      Cl: 0.003
      K: 0.002
    description: "Pulmón deflado (exhalación)"
  
  # Tejido adiposo
  - hu_min: -300
    hu_max: -50
    material: "Adipose"
    density_gcm3: 0.967
    composition:
      H: 0.112
      C: 0.619
      N: 0.017
      O: 0.251
      S: 0.001
    description: "Tejido adiposo (grasa)"
  
  # Tejido blando / Agua
  - hu_min: -50
    hu_max: 50
    material: "G4_WATER"
    density_gcm3: 1.000
    composition:
      H: 0.111894
      O: 0.888106
    description: "Agua / Tejido blando equivalente"
  
  # Músculo
  - hu_min: 50
    hu_max: 100
    material: "Muscle"
    density_gcm3: 1.062
    composition:
      H: 0.102
      C: 0.143
      N: 0.034
      O: 0.710
      Na: 0.001
      P: 0.002
      S: 0.003
      Cl: 0.001
      K: 0.004
    description: "Tejido muscular"
  
  # Tejido conectivo / Órganos densos
  - hu_min: 100
    hu_max: 300
    material: "ConnectiveTissue"
    density_gcm3: 1.120
    composition:
      H: 0.100
      C: 0.120
      N: 0.035
      O: 0.730
      Na: 0.003
      P: 0.005
      S: 0.003
      Cl: 0.002
      K: 0.002
    description: "Tejido conectivo denso"
  
  # Hueso trabecular (esponjoso)
  - hu_min: 300
    hu_max: 700
    material: "BoneTrabecular"
    density_gcm3: 1.159
    composition:
      H: 0.085
      C: 0.404
      N: 0.028
      O: 0.436
      Mg: 0.001
      P: 0.024
      S: 0.001
      Ca: 0.021
    description: "Hueso trabecular (esponjoso)"
  
  # Hueso compacto (cortical)
  - hu_min: 700
    hu_max: 1500
    material: "BoneCortical"
    density_gcm3: 1.575
    composition:
      H: 0.047
      C: 0.144
      N: 0.042
      O: 0.446
      Mg: 0.002
      P: 0.104
      S: 0.003
      Ca: 0.212
    description: "Hueso cortical (compacto)"
  
  # Hueso denso / Dientes
  - hu_min: 1500
    hu_max: 2000
    material: "BoneDense"
    density_gcm3: 1.850
    composition:
      H: 0.034
      C: 0.155
      N: 0.042
      O: 0.435
      Mg: 0.002
      P: 0.103
      S: 0.003
      Ca: 0.226
    description: "Hueso muy denso / Dientes"
  
  # Metal / Implantes (aproximación)
  - hu_min: 2000
    hu_max: 3071
    material: "G4_Ti"  # Titanio como aproximación
    density_gcm3: 4.540
    composition:
      Ti: 1.000
    description: "Implantes metálicos (Titanio)"

# ==================================================
# Fórmula de Conversión HU a Densidad
# ==================================================
# Conversión lineal estándar en dos tramos:
# 
# Para HU < 0 (menos denso que agua):
#   density = 1.0 + HU / 1000
# 
# Para HU >= 0 (más denso que agua):
#   density = 1.0 + HU / 1000  (aproximación lineal)
#   O usar tabla de lookup más precisa
conversion_formula:
  below_water:  # HU < 0
    slope: 0.001
    intercept: 1.0
    formula: "density = 1.0 + HU * 0.001"
  
  above_water:  # HU >= 0
    slope: 0.001
    intercept: 1.0
    formula: "density = 1.0 + HU * 0.001"
    notes: "Para mayor precisión, usar tabla de lookup"

# ==================================================
# Materiales Predefinidos de Geant4
# ==================================================
# Estos materiales están incluidos en la base de datos NIST de Geant4
geant4_nist_materials:
  - "G4_AIR"
  - "G4_WATER"
  - "G4_LUNG_ICRP"
  - "G4_ADIPOSE_TISSUE_ICRP"
  - "G4_MUSCLE_SKELETAL_ICRP"
  - "G4_BONE_COMPACT_ICRU"
  - "G4_BONE_CORTICAL_ICRP"
  - "G4_TISSUE_SOFT_ICRP"
  - "G4_Ti"  # Titanio

# ==================================================
# Configuración para Navegación Voxelizada
# ==================================================
voxelization:
  # Método de navegación
  navigator: "ImageNestedParametrisedVolume"
  # Alternativas:
  # - "ImageRegularParametrisedVolume" (más rápido, más memoria)
  # - "ImageNestedParametrisedVolume" (balanceado)
  
  # Dump de información de materiales
  dump_material_table: false
  
  # Número de materiales únicos esperados
  # (Geant4 puede ralentizarse con miles de materiales ligeramente diferentes)
  expected_unique_materials: 50

# ==================================================
# Validación de la Calibración
# ==================================================
validation:
  # Phantoms de referencia para validación
  reference_phantoms:
    - name: "Gammex 467"
      inserts:
        - name: "Lung LN-300"
          expected_hu: -700
          expected_density: 0.217
        - name: "Adipose AP6"
          expected_hu: -100
          expected_density: 0.967
        - name: "Solid Water"
          expected_hu: 0
          expected_density: 1.000
        - name: "Muscle"
          expected_hu: 50
          expected_density: 1.062
        - name: "Dense Bone SB3"
          expected_hu: 1000
          expected_density: 1.575
  
  # Tolerancias aceptables
  tolerances:
    hu_tolerance: 10  # HU
    density_tolerance_percent: 2.0  # %

# ==================================================
# Referencias Bibliográficas
# ==================================================
references:
  - "Schneider W, Bortfeld T, Schlegel W. Correlation between CT numbers and tissue parameters needed for Monte Carlo simulations of clinical dose distributions. Phys Med Biol. 2000;45(2):459-478."
  - "Vanderstraeten B, et al. Conversion of CT numbers into tissue parameters for Monte Carlo dose calculations. Phys Med Biol. 2007;52(3):539-562."
  - "ICRU Report 46: Photon, Electron, Proton and Neutron Interaction Data for Body Tissues. 1992."
  - "Schneider U, et al. The calibration of CT Hounsfield units for radiotherapy treatment planning. Phys Med Biol. 1996;41(1):111-124."
